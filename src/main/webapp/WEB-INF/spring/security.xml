<?xml version="1.0" encoding="UTF-8" ?>

<beans:beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:context="http://www.springframework.org/schema/context" xmlns:p="http://www.springframework.org/schema/p"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/security
		http://www.springframework.org/schema/security/spring-security.xsd
		http://www.springframework.org/schema/context
		http://www.springframework.org/schema/context/spring-context.xsd">
		
    <security:http auto-config="false" use-expressions="true" entry-point-ref="authenticationEntryPoint">

        <!--<security:logout logout-url="/logout" delete-cookies="JSESSIONID" logout-success-url="/login" invalidate-session="true"/>-->
        <!-- Enable CSRF protection -->
        <security:csrf disabled="false" />
		<security:custom-filter position="REMEMBER_ME_FILTER" ref="rememberMeFilter" />
		<security:custom-filter position="CONCURRENT_SESSION_FILTER" ref="concurrencyFilter" />
		<security:custom-filter position="FORM_LOGIN_FILTER" ref="authenticationFilter" />
		<security:custom-filter position="LOGOUT_FILTER" ref="logoutFilter"/>
		<security:session-management session-authentication-strategy-ref="sas"/>

    </security:http>

    <!-- Remember-me token will live in 2 week -->
	<bean id="rememberMeServices" 
	    class="org.springframework.security.web.authentication.rememberme.PersistentTokenBasedRememberMeServices"
	    p:tokenValiditySeconds="1209600" >
		<constructor-arg value="key"/>
		<constructor-arg ref="userDetailsService"/>
		<constructor-arg ref="jdbcTokenRepository"/>
	    </bean>
	<bean id="jdbcTokenRepository" 
	    class="org.springframework.security.web.authentication.rememberme.JdbcTokenRepositoryImpl"
	    p:dataSource-ref="dataSource"/>
	    
	<bean id="rememberMeAuthenticationProvider" class="org.springframework.security.authentication.RememberMeAuthenticationProvider">
		<constructor-arg value="key"/>
	</bean>
	
	<bean id="rememberMeFilter" 
	    class="org.springframework.security.web.authentication.rememberme.RememberMeAuthenticationFilter">
		<constructor-arg ref="authenticationManager"/>
		<constructor-arg ref="rememberMeServices"/>
		<property name="authenticationSuccessHandler" ref="savedRequestAwareAuthenticationSuccessHandler"/>
	</bean>

	<bean id="logoutFilter"
		  class="org.springframework.security.web.authentication.logout.LogoutFilter">
		<constructor-arg value="/login" />
		<constructor-arg>
			<list>
				<beans:ref bean="rememberMeServices"/>
				<bean class="org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler"/>
			</list>
		</constructor-arg>
		<property name="filterProcessesUrl" value="/logout" />
	</bean>

    <security:authentication-manager  alias="authenticationManager">
        <security:authentication-provider user-service-ref="userDetailsService">
            <security:password-encoder hash="bcrypt" />
        </security:authentication-provider>
		<security:authentication-provider ref="rememberMeAuthenticationProvider" />
    </security:authentication-manager>
	<bean id="authenticationEntryPoint"
		class="org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint">
		<constructor-arg value="/login" />
	</bean>

	<bean id="customAuthenticationFailureHandler"
		class="org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler">
		<constructor-arg name="defaultFailureUrl" value="/login?error"/>
		</bean>
	<bean id="authenticationFilter"
		class="org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter">
		<property name="sessionAuthenticationStrategy" ref="sas" />
		<property name="authenticationManager" ref="authenticationManager" />
		<property name="authenticationFailureHandler" ref="customAuthenticationFailureHandler"/>
		<property name="authenticationSuccessHandler" ref="savedRequestAwareAuthenticationSuccessHandler"/>
		<property name="rememberMeServices" ref="rememberMeServices"/>
	</bean>

	<bean id="concurrencyFilter"
		class="org.springframework.security.web.session.ConcurrentSessionFilter">
		<constructor-arg ref="sessionRegistry" />
		<constructor-arg value="/session-expired" />
	</bean>

	<bean id="sas"
		class="org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy">
		<constructor-arg>
			<list>
				<bean
					class="org.springframework.security.web.authentication.session.ConcurrentSessionControlAuthenticationStrategy">
					<constructor-arg ref="sessionRegistry" />
					<property name="maximumSessions" value="${session.concurrent.maximum}" />
					<property name="exceptionIfMaximumExceeded"
						value="true" />
				</bean>
				<bean
					class="org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy">
				</bean>
				<bean
					class="org.springframework.security.web.authentication.session.RegisterSessionAuthenticationStrategy">
					<constructor-arg ref="sessionRegistry" />
				</bean>
			</list>
		</constructor-arg>
	</bean>

	<bean id="sessionRegistry"
		class="org.springframework.security.core.session.SessionRegistryImpl" />
		
    <bean id="savedRequestAwareAuthenticationSuccessHandler"
          class="com.car.services.security.CustomSavedRequestAwareAuthenticationSuccessHandler">
        <property name="targetUrlParameter" value="targetUrl" />
    </bean>
</beans:beans>
